<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alta de Nuevos Desarrollos</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; display: flex; height: 100vh; }
    
    #map { flex: 1; }
    
    #sidebar {
      width: 450px;
      padding: 20px;
      overflow-y: auto;
      background: #f5f5f5;
      border-left: 2px solid #ddd;
    }
    
    h2 { margin-bottom: 15px; font-size: 18px; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: bold; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 6px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; }
    .form-group input:disabled { background: #e9e9e9; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2563EB; }
    
    .amenidades { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .amenidades label { font-weight: normal; font-size: 12px; }
    
    button { 
      width: 100%; 
      padding: 10px; 
      background: #007bff; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-size: 14px;
      margin-top: 10px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    
    .mensaje { padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; }
    .mensaje.exito { background: #d4edda; color: #155724; }
    .mensaje.error { background: #f8d7da; color: #721c24; }
    
    .readonly { background: #fffbcc; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <h2>üìç Registrar Nuevo Desarrollo</h2>
  
  <div id="mensaje"></div>
  
  <form id="formDesarrollo">
    
    <!-- ========================================== -->
    <!-- INFORMACI√ìN B√ÅSICA -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üìã INFORMACI√ìN B√ÅSICA
    </h3>
    
    <div class="form-group">
      <label>Nombre del Desarrollo *</label>
      <input type="text" id="nombre" required placeholder="Ej: Torre Condesa">
    </div>
    
    <div class="form-group">
      <label>Direcci√≥n</label>
      <input type="text" id="direccion" placeholder="Direcci√≥n completa">
    </div>
    
    <div class="form-group">
      <label>Calle</label>
      <input type="text" id="calle" placeholder="Nombre de la calle">
    </div>
    
    <div class="form-group">
      <label>Alcald√≠a</label>
      <input type="text" id="alcaldia" placeholder="Ej: Benito Ju√°rez">
    </div>
    
    <div class="form-group">
      <label>Colonia</label>
      <input type="text" id="colonia" placeholder="Ej: Del Valle">
    </div>
    
    <div class="form-group">
      <label>C√≥digo Postal</label>
      <input type="text" id="codigo_postal" maxlength="5" placeholder="03100">
    </div>
    
    <!-- ========================================== -->
    <!-- UBICACI√ìN -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üìç UBICACI√ìN (del an√°lisis)
    </h3>
    
    <div class="form-group">
      <label>Latitud *</label>
      <input type="number" step="any" id="latitud" required readonly class="readonly">
    </div>
    
    <div class="form-group">
      <label>Longitud *</label>
      <input type="number" step="any" id="longitud" required readonly class="readonly">
    </div>
    
    <!-- ========================================== -->
    <!-- PRECIOS -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üí∞ PRECIOS
    </h3>
    
    <div class="form-group">
      <label>Precio por m¬≤ (predicho) *</label>
      <input type="number" step="0.01" id="precio_m2" required readonly class="readonly">
    </div>
    
    <div class="form-group">
      <label>Precio Total</label>
      <input type="number" step="0.01" id="precio_total" placeholder="Precio total del desarrollo">
    </div>
    
    <!-- ========================================== -->
    <!-- CARACTER√çSTICAS F√çSICAS -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üìê CARACTER√çSTICAS F√çSICAS
    </h3>
    
    <div class="form-group">
      <label>√Årea Total (m¬≤)</label>
      <input type="number" step="0.01" id="area_total" placeholder="√Årea total construida">
    </div>
    
    <div class="form-group">
      <label>√Årea Terreno (m¬≤)</label>
      <input type="number" step="0.01" id="area_terreno" placeholder="√Årea del terreno">
    </div>
    
    <div class="form-group">
      <label>Rec√°maras</label>
      <input type="number" id="num_recamaras" min="0" placeholder="N√∫mero de rec√°maras">
    </div>
    
    <div class="form-group">
      <label>Ba√±os</label>
      <input type="number" id="num_banos" min="0" placeholder="N√∫mero de ba√±os">
    </div>
    
    <div class="form-group">
      <label>Niveles</label>
      <input type="number" id="niveles" min="0" placeholder="N√∫mero de niveles">
    </div>
    
    <div class="form-group">
      <label>Cajones de Estacionamiento</label>
      <input type="number" id="num_cajones_estacionamiento" min="0" placeholder="Cajones incluidos">
    </div>
    
    <!-- ========================================== -->
    <!-- CALIDAD Y ESTADO -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      ‚≠ê CALIDAD Y ESTADO
    </h3>
    
    <div class="form-group">
      <label>Calidad de Construcci√≥n</label>
      <select id="calidad_construccion">
        <option value="">Seleccionar</option>
        <option value="alta">Alta</option>
        <option value="media">Media</option>
        <option value="econ√≥mica">Econ√≥mica</option>
        <option value="lujo">Lujo</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Acabados</label>
      <select id="acabados">
        <option value="">Seleccionar</option>
        <option value="lujo">Lujo</option>
        <option value="premium">Premium</option>
        <option value="est√°ndar">Est√°ndar</option>
        <option value="b√°sico">B√°sico</option>
        <option value="sin acabados">Sin acabados</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Antig√ºedad (a√±os)</label>
      <input type="number" id="antiguedad" min="0" placeholder="A√±os de antig√ºedad">
    </div>
    
    <div class="form-group">
      <label>Estado de Conservaci√≥n</label>
      <select id="estado_conservacion">
        <option value="">Seleccionar</option>
        <option value="excelente">Excelente</option>
        <option value="bueno">Bueno</option>
        <option value="regular">Regular</option>
        <option value="requiere remodelaci√≥n">Requiere remodelaci√≥n</option>
      </select>
    </div>
    
    <!-- ========================================== -->
    <!-- AMENIDADES -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üèä AMENIDADES
    </h3>
    <div class="amenidades">
      <label><input type="checkbox" id="tiene_alberca"> Alberca</label>
      <label><input type="checkbox" id="tiene_gimnasio"> Gimnasio</label>
      <label><input type="checkbox" id="tiene_areas_verdes"> √Åreas verdes</label>
      <label><input type="checkbox" id="tiene_seguridad_24h"> Seguridad 24h</label>
      <label><input type="checkbox" id="tiene_estacionamiento_visitantes"> Estacionamiento visitantes</label>
    </div>
    
    <!-- ========================================== -->
    <!-- INFORMACI√ìN DEL DESARROLLO -->
    <!-- ========================================== -->
    <h3 style="margin: 15px 0 10px 0; font-size: 13px; color: #60A5FA; border-bottom: 1px solid rgba(96,165,250,0.3); padding-bottom: 5px;">
      üè¢ INFORMACI√ìN DEL DESARROLLO
    </h3>
    
    <div class="form-group">
      <label>Promotor/Desarrollador</label>
      <input type="text" id="promotor" placeholder="Nombre del promotor o empresa">
    </div>
    
    <div class="form-group">
      <label>Tipo de Desarrollo</label>
      <select id="tipo_desarrollo">
        <option value="">Seleccionar</option>
        <option value="vertical">Vertical (torre/edificio)</option>
        <option value="horizontal">Horizontal (casas)</option>
        <option value="mixto">Mixto</option>
        <option value="unifamiliar">Unifamiliar</option>
        <option value="multifamiliar">Multifamiliar</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Unidades Totales</label>
      <input type="number" id="unidades_totales" min="0" placeholder="Total de unidades en el desarrollo">
    </div>
    
    <div class="form-group">
      <label>Unidades Disponibles</label>
      <input type="number" id="unidades_disponibles" min="0" placeholder="Unidades disponibles para venta">
    </div>
    
    <!-- Botones -->
    <button type="submit">üíæ Guardar Desarrollo</button>
    <button type="button" class="btn-secondary" onclick="window.close()">‚ùå Cancelar</button>
  </form>
  
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const SUPABASE_URL = 'https://anyzwlksikreczclzkxc.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXp3bGtzaWtyZWN6Y2x6a3hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTY0NTcsImV4cCI6MjA3NTA5MjQ1N30.sMs4-59Q7ajHLQHJYxVXAhwODlkSREfUNYiQ8BswMjQ';
  
  // Inicializar mapa
  const map = L.map('map').setView([19.39, -99.14], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  
  let marker = null;
  let datosAnalisis = null;
  
  // Funci√≥n para API calls
  const apiPost = (strings, ...values) => {
    const path = strings[0];
    return (data) => fetch(`${SUPABASE_URL}${path}`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(data)
    });
  };
  
  // Cargar datos del an√°lisis desde URL parameters
  function cargarDatosAnalisis() {
    // Intentar obtener datos de URL
    const urlParams = new URLSearchParams(window.location.search);
    const datosParam = urlParams.get('datos');
    
    let datosStr = null;
    
    if (datosParam) {
      // Decodificar desde URL
      try {
        datosStr = decodeURIComponent(atob(datosParam));
      } catch (e) {
        console.error('Error decodificando datos de URL:', e);
      }
    }
    
    // Fallback: intentar localStorage
    if (!datosStr) {
      datosStr = localStorage.getItem('datosAnalisis');
    }
    
    if (!datosStr) {
      mostrarMensaje('‚ö†Ô∏è No hay datos del an√°lisis. Regresa al Mapa 1 y analiza un punto primero.', 'error');
      document.getElementById('formDesarrollo').style.display = 'none';
      return;
    }
    
    try {
      datosAnalisis = JSON.parse(datosStr);
      console.log('Datos recibidos:', datosAnalisis);
      
      // Pre-llenar formulario
      document.getElementById('latitud').value = datosAnalisis.lat || '';
      document.getElementById('longitud').value = datosAnalisis.lng || '';
      document.getElementById('precio_m2').value = datosAnalisis.precio_m2_predicho || '';
      
      // Colocar marcador en el mapa
      if (datosAnalisis.lat && datosAnalisis.lng) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([datosAnalisis.lat, datosAnalisis.lng]).addTo(map);
        map.setView([datosAnalisis.lat, datosAnalisis.lng], 16);
      }
      
      mostrarMensaje('‚úÖ Datos cargados correctamente. Completa la informaci√≥n y guarda.', 'exito');
    } catch (e) {
      console.error('Error parseando datos:', e);
      mostrarMensaje('‚ùå Error al cargar datos del an√°lisis', 'error');
      document.getElementById('formDesarrollo').style.display = 'none';
    }
  }
  
  // Mostrar mensajes
  function mostrarMensaje(texto, tipo) {
    const div = document.getElementById('mensaje');
    div.textContent = texto;
    div.className = `mensaje ${tipo}`;
    div.style.display = 'block';
    
    if (tipo === 'exito') {
      setTimeout(() => { div.style.display = 'none'; }, 5000);
    }
  }
  
  // Guardar desarrollo
  document.getElementById('formDesarrollo').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = '‚è≥ Guardando...';
    
    try {
      console.log('=== INICIO GUARDADO ===');
      
      // Preparar datos con TODOS los campos de la tabla
      const desarrollo = {
        // Informaci√≥n b√°sica
        nombre: document.getElementById('nombre').value,
        direccion: document.getElementById('direccion').value || null,
        calle: document.getElementById('calle').value || null,
        alcaldia: document.getElementById('alcaldia').value || null,
        colonia: document.getElementById('colonia').value || null,
        codigo_postal: document.getElementById('codigo_postal').value || null,
        
        // Ubicaci√≥n
        latitud: parseFloat(document.getElementById('latitud').value),
        longitud: parseFloat(document.getElementById('longitud').value),
        
        // Precios
        precio_m2: parseFloat(document.getElementById('precio_m2').value),
        precio_total: document.getElementById('precio_total').value ? parseFloat(document.getElementById('precio_total').value) : null,
        
        // Caracter√≠sticas f√≠sicas
        area_total: document.getElementById('area_total').value ? parseFloat(document.getElementById('area_total').value) : null,
        area_terreno: document.getElementById('area_terreno').value ? parseFloat(document.getElementById('area_terreno').value) : null,
        num_recamaras: document.getElementById('num_recamaras').value ? parseInt(document.getElementById('num_recamaras').value) : null,
        num_banos: document.getElementById('num_banos').value ? parseInt(document.getElementById('num_banos').value) : null,
        niveles: document.getElementById('niveles').value ? parseInt(document.getElementById('niveles').value) : null,
        num_cajones_estacionamiento: document.getElementById('num_cajones_estacionamiento').value ? parseInt(document.getElementById('num_cajones_estacionamiento').value) : null,
        
        // Calidad y estado
        calidad_construccion: document.getElementById('calidad_construccion').value || null,
        acabados: document.getElementById('acabados').value || null,
        antiguedad: document.getElementById('antiguedad').value ? parseInt(document.getElementById('antiguedad').value) : null,
        estado_conservacion: document.getElementById('estado_conservacion').value || null,
        
        // Amenidades
        tiene_alberca: document.getElementById('tiene_alberca').checked,
        tiene_gimnasio: document.getElementById('tiene_gimnasio').checked,
        tiene_areas_verdes: document.getElementById('tiene_areas_verdes').checked,
        tiene_seguridad_24h: document.getElementById('tiene_seguridad_24h').checked,
        tiene_estacionamiento_visitantes: document.getElementById('tiene_estacionamiento_visitantes').checked,
        
        // Informaci√≥n del desarrollo
        promotor: document.getElementById('promotor').value || null,
        tipo_desarrollo: document.getElementById('tipo_desarrollo').value || null,
        unidades_totales: document.getElementById('unidades_totales').value ? parseInt(document.getElementById('unidades_totales').value) : null,
        unidades_disponibles: document.getElementById('unidades_disponibles').value ? parseInt(document.getElementById('unidades_disponibles').value) : null,
        
        // Estado y metadata
        estado: 'pendiente',
        usuario_registro: 'web_user'
      };
      
      // Generar geometr√≠a (geom) en formato WKT desde lat/lng
      const lat = parseFloat(document.getElementById('latitud').value);
      const lng = parseFloat(document.getElementById('longitud').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        // Formato WKT: POINT(longitud latitud) - nota: lng primero, lat despu√©s
        desarrollo.geom = `SRID=4326;POINT(${lng} ${lat})`;
        console.log('üó∫Ô∏è Geometr√≠a generada:', desarrollo.geom);
      }
      
      // Agregar variables del entorno si existen
      if (datosAnalisis && datosAnalisis.variables_entorno) {
        console.log('Variables de entorno disponibles (solo para referencia, no se guardan):', datosAnalisis.variables_entorno);
        // NOTA: Estas variables son del an√°lisis, NO son columnas de la tabla
        // No se agregan al objeto desarrollo
      }
      
      console.log('üì¶ Datos a guardar:', desarrollo);
      console.log('üîó URL:', `${SUPABASE_URL}/rest/v1/nuevos_desarrollos`);
      
      // Guardar en Supabase
      const response = await apiPost`/rest/v1/nuevos_desarrollos`(desarrollo);
      
      console.log('üì° Response status:', response.status);
      console.log('üì° Response ok:', response.ok);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Error response:', errorText);
        throw new Error(`Error ${response.status}: ${errorText}`);
      }
      
      const responseData = await response.json().catch(() => null);
      console.log('‚úÖ Response data:', responseData);
      
      mostrarMensaje('‚úÖ ¬°Desarrollo guardado exitosamente!', 'exito');
      console.log('=== FIN GUARDADO EXITOSO ===');
      
      // Limpiar datos (si ven√≠an de localStorage)
      try {
        localStorage.removeItem('datosAnalisis');
      } catch (e) {
        // Ignorar error si no hay acceso a localStorage
      }
      
      // Preguntar si desea registrar otro despu√©s de 2 segundos
      setTimeout(() => {
        if (confirm('¬øDeseas registrar otro desarrollo?\n\nS√ç = Regresar al Mapa 1\nNO = Cerrar esta ventana')) {
          window.close();
        } else {
          window.close();
        }
      }, 2000);
      
    } catch (error) {
      console.error('Error al guardar:', error);
      mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
      btn.disabled = false;
      btn.textContent = 'üíæ Guardar Desarrollo';
    }
  });
  
  // Cargar datos al iniciar
  cargarDatosAnalisis();
</script>

</body>
</html>
